<view class="page">
  <!-- 顶部导航 -->
  <t-navbar title="记好帐" fixed="{{false}}" leftArrow="{{false}}" />

  <!-- 顶部月份 + 收支统计 -->
  <view class="header-section">
    <view class="month-and-summary">
      <!-- 月份选择 -->
      <picker mode="date" value="{{pickerDate}}" fields="month" start="2020-01" end="{{maxDate}}" bindchange="onMonthPickerChange" class="month-wrapper">
        <view class="month-main">
          <view class="month-text-col">
            <text class="month-year">{{currentYear}}年</text>
            <view class="month-bottom-row">
              <text class="month-num">{{currentMonth}}月</text>
              <text class="month-arrow">▼</text>
            </view>
          </view>
        </view>
        <text class="month-sub">点击选择月份</text>
      </picker>

      <!-- 收支统计 -->
      <view class="summary-wrapper">
        <view class="summary-card expense">
          <view class="summary-label-row">
            <text class="summary-label">本月支出</text>
            <text class="summary-tag negative">{{expenseChange}}</text>
          </view>
          <text class="summary-amount negative-text">- {{monthExpense}}</text>
        </view>
        <view class="summary-card income">
          <view class="summary-label-row">
            <text class="summary-label">本月收入</text>
            <text class="summary-tag positive">{{incomeChange}}</text>
          </view>
          <text class="summary-amount positive-text">+ {{monthIncome}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 明细列表 -->
  <scroll-view class="content" scroll-y>
    <view wx:for="{{billGroups}}" wx:key="date" class="section">

      <view class="section-header">
        <view class="section-date">
          <text class="section-date-main">{{item.dateText}}</text>
          <text class="section-date-sub">{{item.weekday}}</text>
        </view>
        <view class="section-total">
          <text class="section-total-label">收支</text>
          <text class="section-total-amount {{item.dayNetType === 'expense' ? 'negative-text' : 'positive-text'}}">
            {{item.dayNetTotal}}
          </text>
        </view>
      </view>

      <t-cell-group>
        <t-swipe-cell wx:for="{{item.bills}}" wx:for-item="bill" wx:key="id" wx:for-index="billIndex" left="{{[]}}" right="{{deleteBtnConfig}}" bind:click="onSwipeCellClick" data-bill-id="{{bill.id}}" data-date="{{item.date}}" class="swipe-cell-wrapper">
          <view class="bill-item-wrapper">
            <view class="bill-item">
              <view class="bill-left">
                <view class="bill-icon bill-icon-{{bill.categoryClass}}" catchtap="onEditCategory" data-bill-id="{{bill.id}}">{{bill.icon}}</view>
                <view class="bill-info">
                  <text class="bill-title">{{bill.title}}</text>
                  <!-- Remark Section -->
                  <view class="bill-subtitle" wx:if="{{editingRemarkId === bill.id}}">
                    <text>{{bill.category}} · </text>
                    <input 
                      class="remark-input" 
                      value="{{remarkInputValue}}" 
                      focus="{{true}}" 
                      bindinput="onRemarkInput" 
                      bindconfirm="onRemarkConfirm" 
                      bindblur="onRemarkBlur" 
                    />
                  </view>
                  <view class="bill-subtitle" wx:else>
                     <text>{{bill.category}}{{bill.remark ? ' · ' : ''}}</text>
                     <text catchtap="onEditRemark" data-bill-id="{{bill.id}}" data-remark="{{bill.remark}}" wx:if="{{bill.remark}}">{{bill.remark}}</text>
                     <text catchtap="onEditRemark" data-bill-id="{{bill.id}}" data-remark="{{bill.remark}}" wx:else style="color: #cbd5e1;">点击写备注</text>
                  </view>
                </view>
              </view>
              <view class="bill-right" catchtap="onEditAmount" data-bill-id="{{bill.id}}">
                <text class="bill-amount {{bill.type === 'expense' ? 'negative-text' : 'positive-text'}}">
                  {{bill.type === 'expense' ? '-' : '+'}} {{bill.amount}}
                </text>
              </view>
            </view>
          </view>
        </t-swipe-cell>
      </t-cell-group>
    </view>

    <category-picker 
      visible="{{showCategoryPicker}}" 
      selectedId="{{editingBill.categoryId}}" 
      initialType="{{inputType}}"
      bind:close="onCategoryPickerClose" 
      bind:select="onCategorySelected" 
    />

    <amount-input 
      visible="{{showAmountInput}}" 
      categoryName="{{inputCategoryName}}" 
      initialAmount="{{inputAmount}}" 
      initialDate="{{inputDate}}"
      type="{{inputType}}"
      bind:close="onAmountInputClose" 
      bind:confirm="onAmountConfirmed" 
    />

    <view class="load-more-hint">
      上滑加载更多 · 自动切换至上个月
    </view>
  </scroll-view>

  <!-- Add Button -->
  <view class="fab-add" bindtap="onAddRecord">
    <text class="fab-add-icon">+</text>
  </view>
</view>